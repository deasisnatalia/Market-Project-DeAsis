{% extends 'base.html' %}
{% load static %}
{% block content %}
<div class="container mt-5">

    <div class="card shadow-sm mb-5 no-hover">
        <div class="card-body d-flex">

            <!-- Imagen -->
            <div class="me-4">
                {% if product.image %}
                    <img src="{{ product.image.url }}" alt="{{ product.name }}" class="img-fluid rounded" style="max-width: 250px;">
                {% else %}
                    <img src="{% static 'images/default_product.png' %}" alt="Sin imagen" class="img-fluid rounded" style="max-width: 250px;">
                {% endif %}
            </div>
            <!-- Info -->
            <div class="col-md-8">
                <h2>{{ product.name }}</h2>
                <p>{{ product.description }}</p>
                <p><strong>${{ product.price }}</strong></p>
                <p><strong>Stock:</strong> {{ product.stock }}</p>

                {% if user.is_authenticated %}
                <button class="btn btn-success btn-sm mt-2 add-to-cart-btn" data-product-id="{{ product.id }}">
                    Agregar al carrito
                </button>
                <span id="cart-message" class="ms-2 text-success"></span>
                {% else %}
                <a href="{% url 'users:login' %}" class="btn btn-primary btn-sm mt-2">Inicia sesión para comprar</a>
                {% endif %}
            </div>
        </div>
    </div>

    <h3>Más resultados similares</h3>
    <div class="row">
        {% for p in products %}
            {% if p.id != product.id %}
            <div class="col-md-3 mb-3">
                <div class="card h-100">
                    <a href="{% url 'products:detail' p.id %}">
                        {% if p.image %}
                        <img src="{{ p.image.url }}" class="card-img-top" style="height:150px; object-fit:cover;">
                        {% else %}
                        <img src="{% static 'images/default_product.png' %}" class="card-img-top" style="height:150px; object-fit:cover;">
                        {% endif %}
                    </a>
                    <div class="card-body">
                        <h5 class="card-title">{{ p.name }}</h5>
                        <p class="card-text"><strong>${{ p.price }}</strong></p>
                        
                        {% if user.is_authenticated %}
                        <button class="btn btn-success btn-sm add-to-cart-btn" data-product-id="{{ p.id }}">
                            Agregar al carrito
                        </button>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endif %}
        {% empty %}
        <p>No hay productos similares.</p>
        {% endfor %}
    </div>
</div>
{% endblock %}
{% block extra_js %}
    {{ block.super }}
    {% if user.is_authenticated %}
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const buttons = document.querySelectorAll('.add-to-cart-btn');

            buttons.forEach(btn => {
                const cartMessage = btn.parentElement.querySelector('#cart-message') || null;
                btn.addEventListener('click', function() {
                    const productId = this.dataset.productId;
                    const originalText = this.textContent;
                    this.disabled = true;
                    this.textContent = 'Agregando...';

                    fetch("{% url 'products:add_to_cart_ajax' 0 %}".replace('0', productId), {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': '{{ csrf_token }}',
                            'X-Requested-With': 'XMLHttpRequest'
                        },
                    })
                    .then(res => res.json())
                    .then(data => {
                        if(data.success) {
                            const cartCountElem = document.querySelector('#cart-count');
                            if(cartCountElem) cartCountElem.textContent = data.cart_count;

                            btn.textContent = 'Agregado ✔️';
                            if(cartMessage) cartMessage.textContent = 'Producto agregado al carrito';

                            setTimeout(() => {
                                btn.disabled = false;
                                btn.textContent = originalText;
                                if(cartMessage) cartMessage.textContent = '';
                            }, 1500);
                        } else {
                            btn.disabled = false;
                            btn.textContent = originalText;
                            alert(data.error || 'Error al agregar el producto.');
                        }
                    })
                    .catch(err => {
                        console.error(err);
                        btn.disabled = false;
                        btn.textContent = originalText;
                        alert('Error al agregar el producto.');
                    });
                });
            });
        });
    </script>
    {% endif %}
{% endblock %}
